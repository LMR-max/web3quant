name: Run Multi-Agent Analysis

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¸¦å¯é€‰å‚æ•°ï¼‰
  workflow_dispatch:
    inputs:
      query:
        description: "è‡ªå®šä¹‰åˆ†æžè¯·æ±‚ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤å…¨é¢åˆ†æžï¼‰"
        required: false
        default: ""
      model:
        description: "GitHub Models æ¨¡åž‹é€‰æ‹©"
        required: false
        default: "gpt-4o"
        type: choice
        options:
          - gpt-4o
          - gpt-4o-mini
  # æ¯å‘¨ä¸€è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: "0 8 * * 1" # UTC æ¯å‘¨ä¸€ 08:00

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  analyze:
    name: 6-Agent Optimization Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-agenthq.txt
          pip install python-dotenv

      - name: ðŸ”‘ Configure environment
        run: |
          cat > agents/.env << EOF
          LLM_BACKEND=github
          GITHUB_TOKEN=${{ secrets.MODELS_TOKEN }}
          GITHUB_MODEL_ID=${{ inputs.model || 'gpt-4o' }}
          EOF

      - name: ðŸ¤– Run Multi-Agent Analysis
        env:
          LLM_BACKEND: github
          GITHUB_TOKEN: ${{ secrets.MODELS_TOKEN }}
          GITHUB_MODEL_ID: ${{ inputs.model || 'gpt-4o' }}
        run: |
          echo "================================================"
          echo "Starting 6-Agent Optimization Analysis..."
          echo "Model: $GITHUB_MODEL_ID"
          echo "================================================"

          QUERY="${{ inputs.query }}"
          if [ -z "$QUERY" ]; then
            python agents/main.py --cli 2>&1 | tee analysis_output.txt
          else
            python agents/main.py --cli --query "$QUERY" 2>&1 | tee analysis_output.txt
          fi

      - name: ðŸ“Š Generate report artifact
        if: always()
        run: |
          mkdir -p reports
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          cp analysis_output.txt "reports/analysis_${TIMESTAMP}.txt"

          # ç”Ÿæˆ Markdown æŠ¥å‘Š
          cat > "reports/analysis_${TIMESTAMP}.md" << 'HEADER'
          # Web3Quant Multi-Agent Analysis Report

          **Generated by**: GitHub Actions  
          **Date**: $(date -u '+%Y-%m-%d %H:%M UTC')  
          **Model**: ${{ inputs.model || 'gpt-4o' }}  
          **Trigger**: ${{ github.event_name }}

          ---

          HEADER
          cat analysis_output.txt >> "reports/analysis_${TIMESTAMP}.md"

      - name: ðŸ“¤ Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-analysis-report
          path: reports/
          retention-days: 90

      - name: ðŸ’¬ Post summary to Actions
        if: always()
        run: |
          echo "## ðŸ¤– Multi-Agent Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ inputs.model || 'gpt-4o' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | 6 (parallel) |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æå–å…³é”®æ•°æ®
          if [ -f analysis_output.txt ]; then
            FINDINGS=$(grep -o 'å‘çŽ° \*\*[0-9]*\*\*' analysis_output.txt | head -1 || echo "N/A")
            echo "### Findings: $FINDINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>ðŸ“‹ Full Report (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -100 analysis_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
